# çŸ­é‚®ç³»ç»Ÿæ¶æ„ - åŸºäºPWPåè®®å¯¹é½ç‰ˆ
## é¡¹ç›®å›¢é˜Ÿç®¡ç†çš„ç§»åŠ¨ç«¯å†³ç­–äº¤æµåŠŸèƒ½

**ç‰ˆæœ¬**: v2.0 (PWPå¯¹é½ç‰ˆ)
**æ—¥æœŸ**: 2026-02-03
**æ ¸å¿ƒå®šä½**: çŸ­é‚® = é¡¹ç›®å›¢é˜Ÿç®¡ç†ä¸­åŸºäºPWPåè®®çš„ç§»åŠ¨ç«¯å†³ç­–äº¤æµ

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ ¸å¿ƒå®šä½é‡æ–°æ˜ç¡®

### 1.1 çŸ­é‚®çš„æœ¬è´¨

```
âŒ é”™è¯¯ç†è§£ï¼š
â”œâ”€ çŸ­é‚®æ˜¯ç‹¬ç«‹çš„é€šè®¯å·¥å…·
â”œâ”€ çŸ­é‚®æ˜¯æ–°çš„æ•°æ®æ¨¡å‹
â””â”€ çŸ­é‚®ç‹¬ç«‹äºé¡¹ç›®ç³»ç»Ÿ

âœ… æ­£ç¡®ç†è§£ï¼š
â”œâ”€ çŸ­é‚®æ˜¯é¡¹ç›®å›¢é˜Ÿç®¡ç†åŠŸèƒ½çš„ç§»åŠ¨ç«¯ç•Œé¢
â”œâ”€ çŸ­é‚®åŸºäºPWPåè®®è®°å½•åä½œè¿‡ç¨‹
â”œâ”€ çŸ­é‚®ä¸é¡¹ç›®ä¸»é¡µå…±äº«åŒä¸€æ•°æ®æº
â””â”€ çŸ­é‚®ä¸“æ³¨äºå†³ç­–äº¤æµåœºæ™¯
```

### 1.2 PWPåè®®çš„è§’è‰²

```
PWPï¼ˆPersonal Workspace Protocolï¼‰= ä¸ªäººå·¥ä½œç©ºé—´åè®®

æ ¸å¿ƒèŒè´£:
â”œâ”€ ä¸å¯ç¯¡æ”¹åœ°è®°å½•æ¯ä¸ªäººçš„å®Œæ•´å·¥ä½œè¿‡ç¨‹
â”œâ”€ è®°å½•ä»»åŠ¡æ‰§è¡Œã€æ—¶é—´æŠ•å…¥ã€äº§å‡ºè´¨é‡
â”œâ”€ è®°å½•åä½œäº¤äº’ï¼ˆåŒ…æ‹¬å†³ç­–äº¤æµï¼‰â­
â””â”€ ä½œä¸ºæ¿€åŠ±åˆ†é…å’Œå­¦ä¹ ç³»ç»Ÿçš„æ•°æ®æº

çŸ­é‚®åœ¨PWPä¸­çš„ä½ç½®:
â””â”€ åä½œäº¤äº’è®°å½•çš„ä¸€ç§ç±»å‹
   â””â”€ ä¸“æ³¨äºå†³ç­–äº¤æµçš„ç§»åŠ¨ç«¯å‘ˆç°
```

### 1.3 ä¸é¡¹ç›®ä¸»é¡µçš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é¡¹ç›®æ•°æ®ï¼ˆå”¯ä¸€çœŸç›¸æºï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  PWP Records (åä½œè®°å½•)                 â”‚
â”‚  â”œâ”€ ä»»åŠ¡æ‰§è¡Œè®°å½•                        â”‚
â”‚  â”œâ”€ å†³ç­–äº¤æµè®°å½• â­ (çŸ­é‚®)             â”‚
â”‚  â”œâ”€ æ—¶é—´æŠ•å…¥è®°å½•                        â”‚
â”‚  â””â”€ åä½œäº’åŠ¨è®°å½•                        â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“               â†“
    æ¡Œé¢ç«¯å‘ˆç°       ç§»åŠ¨ç«¯å‘ˆç°
         â†“               â†“
  project-detail.html  shortmail-mvp.html
  (é¡¹ç›®ä¸»é¡µ)          (çŸ­é‚®ç•Œé¢)

  å±•ç¤ºç›¸åŒçš„æ•°æ®ï¼Œåªæ˜¯å‘ˆç°æ–¹å¼ä¸åŒ
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šé‡æ–°è®¾è®¡çš„æ•°æ®æ¶æ„

### 2.1 ä¸éœ€è¦æ–°è¡¨ï¼Œæ‰©å±•ç°æœ‰PWPè®°å½•

**æ ¸å¿ƒæ€è·¯ï¼šçŸ­é‚®ä¸æ˜¯æ–°è¡¨ï¼Œè€Œæ˜¯pwp_recordsçš„ä¸€ç§ç±»å‹**

#### ç°æœ‰ pwp_records è¡¨æ‰©å±•

```prisma
model PWPRecord {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  projectId         String?  @map("project_id")

  // äº‹ä»¶ç±»å‹ï¼ˆæ‰©å±•ï¼‰
  eventType         String   @map("event_type")
  // ç°æœ‰: task_completed, member_joined, etc.
  // æ–°å¢: decision_request | decision_response |
  //       deliverable_submitted | feedback_given | etc.

  // äº‹ä»¶æ•°æ®ï¼ˆçµæ´»çš„JSONç»“æ„ï¼‰
  eventData         Json     @map("event_data")
  // å¯¹äºå†³ç­–äº¤æµç±»å‹ï¼ŒåŒ…å«:
  // {
  //   "type": "decision_request",
  //   "summary": "UIé…è‰²æ–¹æ¡ˆé€‰æ‹©",
  //   "content": {...},
  //   "attachments": [...],
  //   "toUserId": "xxx",
  //   "protocolType": "DECISION_REQUIRED",
  //   "aiSuggestions": {...},
  //   "response": null,
  //   "conversationId": "xxx"
  // }

  // å…³è”å®ä½“ï¼ˆä¿æŒçµæ´»æ€§ï¼‰
  relatedEntityType String?  @map("related_entity_type")
  relatedEntityId   String?  @map("related_entity_id")

  // çŠ¶æ€ï¼ˆæ–°å¢ï¼‰
  status            String?  @default("active")
  // active | responded | archived

  // æ—¶é—´æˆ³
  occurredAt        DateTime @default(now()) @map("occurred_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // å…³è”
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project           Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([projectId])
  @@index([eventType])
  @@index([status])
  @@index([occurredAt(sort: Desc)])
  @@map("pwp_records")
}
```

### 2.2 å†³ç­–äº¤æµçš„PWPäº‹ä»¶ç±»å‹å®šä¹‰

```javascript
// å†³ç­–äº¤æµç›¸å…³çš„PWPäº‹ä»¶ç±»å‹

const DecisionEventTypes = {
  // 1. ä»»åŠ¡åˆ†é…
  TASK_ASSIGNMENT_REQUEST: 'task_assignment_request',
  TASK_ASSIGNMENT_RESPONSE: 'task_assignment_response',

  // 2. äº¤ä»˜ç‰©æäº¤
  DELIVERABLE_SUBMITTED: 'deliverable_submitted',
  DELIVERABLE_REVIEWED: 'deliverable_reviewed',

  // 3. åé¦ˆè¯·æ±‚
  FEEDBACK_REQUESTED: 'feedback_requested',
  FEEDBACK_PROVIDED: 'feedback_provided',

  // 4. å†³ç­–è¯·æ±‚
  DECISION_REQUESTED: 'decision_requested',
  DECISION_MADE: 'decision_made',

  // 5. ä¿¡æ¯åŒæ­¥
  INFO_SHARED: 'info_shared',
  INFO_ACKNOWLEDGED: 'info_acknowledged',
};

// PWPè®°å½•æ•°æ®ç»“æ„ç¤ºä¾‹
const pwpRecordExample = {
  id: 'uuid',
  userId: 'alice-id', // å‘èµ·è€…
  projectId: 'project-x-id',
  eventType: 'decision_requested',
  eventData: {
    // å†³ç­–äº¤æµçš„å®Œæ•´æ•°æ®
    summary: 'UIé…è‰²æ–¹æ¡ˆé€‰æ‹©',
    content: {
      text: 'å‡†å¤‡äº†ä¸‰ä¸ªé…è‰²æ–¹æ¡ˆ...',
      richContent: null
    },
    attachments: [
      { type: 'image', url: '...' },
      { type: 'image', url: '...' }
    ],

    // äº¤æµå…ƒæ•°æ®
    toUserId: 'bob-id',
    protocolType: 'DECISION_REQUIRED',
    priority: 'medium',

    // AIè¾…åŠ©
    aiSuggestions: {
      decisionFramework: {
        question: 'è¿™ä¸ªè®¾è®¡ç¨¿è´¨é‡å¦‚ä½•ï¼Ÿ',
        options: ['æ‰¹å‡†', 'éœ€è¦æ”¹', 'éœ€è¦è®¨è®º']
      },
      complexity: 5
    },

    // å“åº”æ•°æ®
    response: null, // æœªå“åº”æ—¶ä¸ºnull
    respondedBy: null,
    respondedAt: null,

    // å¯¹è¯å…³è”
    conversationId: 'conv-uuid',
    replyToId: null // å¦‚æœæ˜¯å›å¤
  },
  relatedEntityType: null,
  relatedEntityId: null,
  status: 'active', // active | responded | archived
  occurredAt: '2026-02-03T12:00:00Z',
  updatedAt: '2026-02-03T12:00:00Z'
};
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šAPIè®¾è®¡å¯¹é½

### 3.1 ä¸æ˜¯ç‹¬ç«‹çš„çŸ­é‚®APIï¼Œè€Œæ˜¯PWPè®°å½•çš„æŸ¥è¯¢å’Œåˆ›å»º

```javascript
// ========== PWPè®°å½•APIï¼ˆæ‰©å±•å†³ç­–äº¤æµåŠŸèƒ½ï¼‰==========

// 1. åˆ›å»ºå†³ç­–äº¤æµè®°å½•ï¼ˆå³"å‘é€çŸ­é‚®"ï¼‰
POST /api/pwp/decision-requests
Body: {
  projectId: 'project-x-id',
  toUserId: 'bob-id',
  summary: 'UIé…è‰²æ–¹æ¡ˆé€‰æ‹©',
  content: {...},
  attachments: [...],
  protocolType: 'DECISION_REQUIRED'
}
Response: PWPRecord (eventType: decision_requested)

// 2. å“åº”å†³ç­–è¯·æ±‚ï¼ˆå³"å“åº”çŸ­é‚®"ï¼‰
POST /api/pwp/decision-responses
Body: {
  requestId: 'pwp-record-id',
  decision: 'æ‰¹å‡†',
  comment: 'å¾ˆå¥½çš„è®¾è®¡'
}
Response: PWPRecord (eventType: decision_made)

// 3. è·å–é¡¹ç›®çš„å†³ç­–äº¤æµè®°å½•ï¼ˆå³"çŸ­é‚®åˆ—è¡¨"ï¼‰
GET /api/pwp/project/:projectId/decisions
Query: {
  userId: 'xxx', // å¯é€‰ï¼Œè¿‡æ»¤æ¥æ”¶è€…
  status: 'active', // active | responded | archived
  eventTypes: ['decision_requested', 'task_assignment_request']
}
Response: PWPRecord[]

// 4. è·å–ç”¨æˆ·çš„å¾…å†³ç­–äº‹é¡¹ï¼ˆå³"æ”¶ä»¶ç®±"ï¼‰
GET /api/pwp/user/:userId/pending-decisions
Query: {
  projectId: 'xxx', // å¯é€‰ï¼Œè¿‡æ»¤é¡¹ç›®
}
Response: PWPRecord[] (where eventData.toUserId = userId and status = active)

// 5. è·å–å†³ç­–å¯¹è¯çº¿ç¨‹
GET /api/pwp/conversations/:conversationId
Response: PWPRecord[] (ordered by occurredAt)

// 6. è·å–é¡¹ç›®å®Œæ•´æ—¶é—´çº¿ï¼ˆæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å…±ç”¨ï¼‰
GET /api/pwp/project/:projectId/timeline
Response: PWPRecord[] (æ‰€æœ‰ç±»å‹çš„è®°å½•ï¼ŒåŒ…æ‹¬å†³ç­–äº¤æµ)
```

### 3.2 ä¸ç°æœ‰é¡¹ç›®APIçš„å…³ç³»

```javascript
// ç°æœ‰çš„é¡¹ç›®APIä¿æŒä¸å˜
GET /api/projects/:id

// é¡¹ç›®è¯¦æƒ…ä¸­åŒ…å«PWPè®°å½•çš„ç»Ÿè®¡
Response: {
  project: {...},
  members: [...],
  tasks: [...],
  pwpSummary: {
    totalRecords: 150,
    decisionRequests: 23, // â­ å†³ç­–äº¤æµæ•°é‡
    tasksCompleted: 45,
    totalContributions: {...}
  }
}

// é¡¹ç›®ä¸»é¡µï¼ˆæ¡Œé¢ç«¯ï¼‰å’ŒçŸ­é‚®ï¼ˆç§»åŠ¨ç«¯ï¼‰éƒ½æŸ¥è¯¢åŒæ ·çš„PWPè®°å½•
// åªæ˜¯å±•ç¤ºæ–¹å¼ä¸åŒ
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šå‰ç«¯å¯¹é½

### 4.1 æ¡Œé¢ç«¯ï¼ˆé¡¹ç›®ä¸»é¡µï¼‰å±•ç¤ºå†³ç­–äº¤æµ

**project-detail.html ä¸­æ·»åŠ å†³ç­–äº¤æµæ—¶é—´çº¿**

```html
<!-- é¡¹ç›®ä¸»é¡µ - æ´»åŠ¨æ—¶é—´çº¿æ ‡ç­¾ -->
<div class="timeline-section">
  <h3>é¡¹ç›®æ´»åŠ¨</h3>

  <!-- æ‰€æœ‰PWPè®°å½• -->
  <div class="timeline">
    <!-- ä»»åŠ¡å®Œæˆè®°å½• -->
    <div class="timeline-item">
      <span class="event-type">âœ… ä»»åŠ¡å®Œæˆ</span>
      <span class="event-user">Alice</span>
      <span class="event-time">2å°æ—¶å‰</span>
      <div class="event-details">å®Œæˆäº†ç”¨æˆ·è®¤è¯æ¨¡å—</div>
    </div>

    <!-- å†³ç­–äº¤æµè®°å½• â­ -->
    <div class="timeline-item">
      <span class="event-type">ğŸ¨ å†³ç­–è¯·æ±‚</span>
      <span class="event-user">Bob â†’ Alice</span>
      <span class="event-time">3å°æ—¶å‰</span>
      <div class="event-details">
        UIé…è‰²æ–¹æ¡ˆé€‰æ‹©
        <span class="status-badge">å¾…å†³ç­–</span>
      </div>
    </div>

    <!-- æˆå‘˜åŠ å…¥è®°å½• -->
    <div class="timeline-item">
      <span class="event-type">ğŸ‘¥ æˆå‘˜åŠ å…¥</span>
      <span class="event-user">Charlie</span>
      <span class="event-time">æ˜¨å¤©</span>
      <div class="event-details">åŠ å…¥äº†é¡¹ç›®å›¢é˜Ÿ</div>
    </div>
  </div>
</div>
```

### 4.2 ç§»åŠ¨ç«¯ï¼ˆçŸ­é‚®ï¼‰åªå±•ç¤ºå†³ç­–äº¤æµç±»è®°å½•

**shortmail-mvp.html åªè¿‡æ»¤æ˜¾ç¤ºå†³ç­–äº¤æµç±»å‹çš„PWPè®°å½•**

```javascript
// ç§»åŠ¨ç«¯çŸ­é‚® - åªæ˜¾ç¤ºå†³ç­–äº¤æµç±»è®°å½•
async function loadShortMails() {
  // è°ƒç”¨åŒæ ·çš„PWP APIï¼Œåªæ˜¯è¿‡æ»¤æ¡ä»¶ä¸åŒ
  const response = await fetch(`/api/pwp/user/${currentUserId}/pending-decisions`);
  const pwpRecords = await response.json();

  // pwpRecords å°±æ˜¯PWPè®°å½•ï¼Œåªæ˜¯eventTypeæ˜¯å†³ç­–äº¤æµç›¸å…³çš„
  renderShortMailList(pwpRecords);
}

function renderShortMailList(pwpRecords) {
  pwpRecords.forEach(record => {
    // record.eventData åŒ…å«æ‰€æœ‰çŸ­é‚®éœ€è¦çš„æ•°æ®
    const { summary, content, attachments, toUserId, aiSuggestions } = record.eventData;

    // æ¸²æŸ“çŸ­é‚®å¡ç‰‡
    // ...
  });
}
```

### 4.3 æ•°æ®ä¸€è‡´æ€§ä¿è¯

```
æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯çœ‹åˆ°çš„æ˜¯åŒä¸€ä»½æ•°æ®ï¼š

PWP Records Table
â”œâ”€ eventType: decision_requested
â”œâ”€ eventData: { summary, content, toUserId, ... }
â”œâ”€ status: active
â””â”€ occurredAt: 2026-02-03 12:00

æ¡Œé¢ç«¯æŸ¥è¯¢:
GET /api/pwp/project/xxx/timeline
â†’ æ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„PWPè®°å½•ï¼ˆåŒ…æ‹¬å†³ç­–äº¤æµï¼‰

ç§»åŠ¨ç«¯æŸ¥è¯¢:
GET /api/pwp/user/xxx/pending-decisions
â†’ åªæ˜¾ç¤ºå†³ç­–äº¤æµç±»å‹çš„PWPè®°å½•

æ•°æ®æºå®Œå…¨ä¸€è‡´ âœ“
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šç®€åŒ–çš„å®ç°æ–¹æ¡ˆ

### 5.1 æ•°æ®åº“è¿ç§»ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

```sql
-- åªéœ€è¦æ‰©å±•ç°æœ‰çš„ pwp_records è¡¨

-- 1. æ·»åŠ  status å­—æ®µ
ALTER TABLE pwp_records ADD COLUMN status VARCHAR(50) DEFAULT 'active';

-- 2. æ·»åŠ ç´¢å¼•
CREATE INDEX idx_pwp_status ON pwp_records(status);
CREATE INDEX idx_pwp_event_type ON pwp_records(event_type);

-- 3. æ‰©å±• eventType æšä¸¾ï¼ˆåº”ç”¨å±‚æ§åˆ¶ï¼‰
-- æ–°å¢å†³ç­–äº¤æµç›¸å…³ç±»å‹ï¼š
-- - decision_requested
-- - decision_made
-- - task_assignment_request
-- - task_assignment_response
-- - deliverable_submitted
-- - deliverable_reviewed
-- - feedback_requested
-- - feedback_provided

-- å®Œæˆï¼ä¸éœ€è¦æ–°å»ºè¡¨
```

### 5.2 åç«¯å®ç°ï¼ˆæ‰©å±•PWPæœåŠ¡ï¼‰

```javascript
// src/services/pwpService.jsï¼ˆæ‰©å±•ï¼‰

class PWPService {
  // ç°æœ‰åŠŸèƒ½ï¼šè®°å½•ä»»åŠ¡å®Œæˆã€æˆå‘˜åŠ å…¥ç­‰
  async recordEvent(userId, eventType, eventData, projectId = null) {
    // ç°æœ‰å®ç°
  }

  // æ–°å¢ï¼šåˆ›å»ºå†³ç­–è¯·æ±‚ï¼ˆå³"å‘é€çŸ­é‚®"ï¼‰
  async createDecisionRequest({ fromUserId, toUserId, projectId, summary, content, attachments, protocolType }) {
    // AIåˆ†æ
    const aiSuggestions = await this.aiRouterService.analyze(summary, content);

    // ç”ŸæˆconversationId
    const conversationId = uuidv4();

    // åˆ›å»ºPWPè®°å½•
    return await this.recordEvent(
      fromUserId,
      'decision_requested',
      {
        summary,
        content,
        attachments,
        toUserId,
        protocolType,
        aiSuggestions,
        conversationId,
        response: null,
        respondedBy: null,
        respondedAt: null
      },
      projectId
    );
  }

  // æ–°å¢ï¼šå“åº”å†³ç­–è¯·æ±‚ï¼ˆå³"å“åº”çŸ­é‚®"ï¼‰
  async respondToDecision(requestId, responderId, decision, comment) {
    // 1. æ›´æ–°åŸè¯·æ±‚è®°å½•çš„statusä¸ºresponded
    await prisma.pWPRecord.update({
      where: { id: requestId },
      data: {
        status: 'responded',
        eventData: {
          ...original.eventData,
          response: decision,
          respondedBy: responderId,
          respondedAt: new Date()
        }
      }
    });

    // 2. åˆ›å»ºå“åº”è®°å½•
    return await this.recordEvent(
      responderId,
      'decision_made',
      {
        requestId,
        decision,
        comment,
        conversationId: original.eventData.conversationId
      },
      original.projectId
    );
  }

  // æ–°å¢ï¼šè·å–ç”¨æˆ·çš„å¾…å†³ç­–äº‹é¡¹
  async getPendingDecisions(userId) {
    return await prisma.pWPRecord.findMany({
      where: {
        eventType: {
          in: ['decision_requested', 'task_assignment_request', 'feedback_requested']
        },
        status: 'active',
        eventData: {
          path: ['toUserId'],
          equals: userId
        }
      },
      orderBy: { occurredAt: 'desc' },
      include: {
        user: true,
        project: true
      }
    });
  }

  // æ–°å¢ï¼šè·å–å¯¹è¯çº¿ç¨‹
  async getConversation(conversationId) {
    return await prisma.pWPRecord.findMany({
      where: {
        eventData: {
          path: ['conversationId'],
          equals: conversationId
        }
      },
      orderBy: { occurredAt: 'asc' },
      include: {
        user: true
      }
    });
  }
}
```

### 5.3 APIè·¯ç”±ï¼ˆåŸºäºPWPï¼‰

```javascript
// src/routes/pwp.jsï¼ˆæ‰©å±•ï¼‰

// ========== å†³ç­–äº¤æµç›¸å…³API ==========

// åˆ›å»ºå†³ç­–è¯·æ±‚
router.post('/decision-requests', authenticateToken, async (req, res) => {
  const { projectId, toUserId, summary, content, attachments, protocolType } = req.body;

  const record = await pwpService.createDecisionRequest({
    fromUserId: req.userId,
    toUserId,
    projectId,
    summary,
    content,
    attachments,
    protocolType
  });

  res.json({ success: true, record });
});

// å“åº”å†³ç­–è¯·æ±‚
router.post('/decision-responses', authenticateToken, async (req, res) => {
  const { requestId, decision, comment } = req.body;

  const record = await pwpService.respondToDecision(
    requestId,
    req.userId,
    decision,
    comment
  );

  res.json({ success: true, record });
});

// è·å–å¾…å†³ç­–äº‹é¡¹ï¼ˆå³"çŸ­é‚®æ”¶ä»¶ç®±"ï¼‰
router.get('/user/:userId/pending-decisions', authenticateToken, async (req, res) => {
  const records = await pwpService.getPendingDecisions(req.params.userId);
  res.json({ success: true, records });
});

// è·å–é¡¹ç›®çš„å†³ç­–äº¤æµè®°å½•
router.get('/project/:projectId/decisions', authenticateToken, async (req, res) => {
  const records = await pwpService.getProjectDecisions(req.params.projectId, req.query);
  res.json({ success: true, records });
});

// è·å–å¯¹è¯çº¿ç¨‹
router.get('/conversations/:conversationId', authenticateToken, async (req, res) => {
  const records = await pwpService.getConversation(req.params.conversationId);
  res.json({ success: true, records });
});

// ========== ç°æœ‰PWP APIä¿æŒä¸å˜ ==========
router.get('/user/:userId/timeline', ...);
router.get('/project/:projectId/timeline', ...);
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šå¼€å‘è®¡åˆ’å¯¹é½

### 6.1 ç®€åŒ–åçš„å¼€å‘ä»»åŠ¡

```
Phase 1: æ•°æ®åº“å’Œåç«¯ï¼ˆ1å‘¨ï¼‰
â”œâ”€ æ‰©å±•pwp_recordsè¡¨ï¼ˆæ·»åŠ statuså­—æ®µå’Œç´¢å¼•ï¼‰
â”œâ”€ æ‰©å±•PWPServiceï¼ˆå†³ç­–äº¤æµæ–¹æ³•ï¼‰
â”œâ”€ æ–°å¢PWP APIè·¯ç”±ï¼ˆå†³ç­–äº¤æµç›¸å…³ï¼‰
â””â”€ AIè·¯ç”±æœåŠ¡ï¼ˆå†³ç­–æ¡†æ¶ç”Ÿæˆï¼‰

Phase 2: ç§»åŠ¨ç«¯å‰ç«¯ï¼ˆ1.5å‘¨ï¼‰
â”œâ”€ shortmail-inboxï¼ˆåŸºäºPWPè®°å½•ï¼‰
â”œâ”€ shortmail-detailï¼ˆå±•ç¤ºPWPè®°å½•è¯¦æƒ…ï¼‰
â”œâ”€ shortmail-composeï¼ˆåˆ›å»ºPWPå†³ç­–è¯·æ±‚ï¼‰
â””â”€ shortmail-chainï¼ˆPWPå¯¹è¯çº¿ç¨‹ï¼‰

Phase 3: æ¡Œé¢ç«¯é›†æˆï¼ˆ0.5å‘¨ï¼‰
â”œâ”€ project-detailæ·»åŠ å†³ç­–äº¤æµæ—¶é—´çº¿
â”œâ”€ dashboardæ·»åŠ å¾…å†³ç­–æç¤º
â””â”€ æ•°æ®ä¸€è‡´æ€§éªŒè¯

Phase 4: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰
â”œâ”€ ç«¯åˆ°ç«¯æµ‹è¯•
â”œâ”€ æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
â””â”€ æ€§èƒ½ä¼˜åŒ–

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»è®¡: 4å‘¨ï¼ˆè€ŒéåŸè®¡åˆ’çš„5å‘¨ï¼‰âš¡
```

### 6.2 æ ¸å¿ƒä¼˜åŠ¿

```
âœ… ä¸éœ€è¦æ–°è¡¨ï¼Œå¤ç”¨pwp_records
âœ… æ•°æ®å¤©ç„¶ä¸€è‡´ï¼ˆæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯ï¼‰
âœ… ç¬¦åˆPWPåè®®è®¾è®¡ç†å¿µ
âœ… ä¸é¡¹ç›®ç®¡ç†æ·±åº¦æ•´åˆ
âœ… æ›´ç®€å•çš„æ•°æ®æ¨¡å‹
âœ… æ›´å¿«çš„å¼€å‘å‘¨æœŸ
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå…³é”®æ¦‚å¿µå¯¹é½è¡¨

| ä¹‹å‰çš„ç†è§£ | å¯¹é½åçš„ç†è§£ |
|-----------|-------------|
| çŸ­é‚®æ˜¯ç‹¬ç«‹çš„é€šè®¯å·¥å…· | çŸ­é‚®æ˜¯é¡¹ç›®å›¢é˜Ÿç®¡ç†çš„ç§»åŠ¨ç«¯å†³ç­–äº¤æµåŠŸèƒ½ |
| short_mails ç‹¬ç«‹è¡¨ | pwp_records çš„å†³ç­–äº¤æµç±»å‹è®°å½• |
| ç‹¬ç«‹çš„çŸ­é‚®API | PWP APIçš„å†³ç­–äº¤æµæ‰©å±• |
| ä¸é¡¹ç›®ç³»ç»Ÿæ¾è€¦åˆ | ä¸é¡¹ç›®ç³»ç»Ÿç´§å¯†é›†æˆ |
| ç§»åŠ¨ç«¯ç‹¬æœ‰æ•°æ® | æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å…±äº«PWPæ•°æ® |

---

## æ€»ç»“

### æ ¸å¿ƒç†è§£

```
çŸ­é‚® â‰  æ–°äº§å“
çŸ­é‚® = é¡¹ç›®å›¢é˜Ÿç®¡ç†ä¸­åŸºäºPWPåè®®çš„ç§»åŠ¨ç«¯å†³ç­–äº¤æµç•Œé¢

æ•°æ®å±‚: pwp_records (ç»Ÿä¸€æ•°æ®æº)
     â†“
ä¸šåŠ¡å±‚: PWPService (å†³ç­–äº¤æµæ–¹æ³•æ‰©å±•)
     â†“
å±•ç°å±‚: æ¡Œé¢ç«¯ï¼ˆé¡¹ç›®æ—¶é—´çº¿ï¼‰+ ç§»åŠ¨ç«¯ï¼ˆçŸ­é‚®ç•Œé¢ï¼‰
```

### ç«‹å³å¯ä»¥å¼€å§‹

```bash
# 1. æ‰©å±•pwp_recordsè¡¨
ALTER TABLE pwp_records ADD COLUMN status VARCHAR(50) DEFAULT 'active';

# 2. æ‰©å±•PWPService
# æ·»åŠ å†³ç­–äº¤æµç›¸å…³æ–¹æ³•

# 3. åˆ›å»ºç§»åŠ¨ç«¯ç•Œé¢
# åŸºäºPWPè®°å½•æ¸²æŸ“çŸ­é‚®åˆ—è¡¨

# 4å‘¨åå®ŒæˆMVP âš¡
```

---

**ã€äº”è¡Œå±æ€§ã€‘**ï¼šâš™ï¸é‡‘ï¼ˆæ¶æ„å¯¹é½ï¼‰ + ğŸŒ³æœ¨ï¼ˆå‡†å¤‡å®ç°ï¼‰
**ã€é“æ³•æœ¯åŠ¿å™¨ã€‘**ï¼šé“ï¼ˆå®šä½æ¸…æ™°ï¼‰â†’ æ³•ï¼ˆæ¶æ„å¯¹é½ï¼‰
**ã€å¿ƒæ³•ã€‘**ï¼šæ˜é“ä»¥å®šæ–¹å‘ï¼Œç«‹æ³•ä»¥èšç»“æ„
