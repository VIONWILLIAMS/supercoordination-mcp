<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å·¥ä½œå° - è¶…åä½“</title>
    <script src="/js/auth.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="/js/websocket-client.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .topbar {
            background: white;
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .username {
            font-weight: 600;
            color: #333;
        }

        .points {
            font-size: 13px;
            color: #666;
        }

        .points-value {
            color: #ffa726;
            font-weight: 600;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #e0e0e0;
            color: #333;
        }

        /* å¯¼èˆªèœå• */
        .navbar-nav {
            display: flex;
            gap: 8px;
            margin-left: 24px;
        }

        .nav-link {
            padding: 8px 16px;
            color: #666;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: #f0f0f0;
            color: #333;
        }

        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        @media (max-width: 900px) {
            .navbar-nav {
                display: none;
            }
        }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 20px;
        }

        /* å¿«é€Ÿæ“ä½œå¡ç‰‡ */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .quick-actions {
                grid-template-columns: 1fr 1fr;
            }
        }

        .action-btn {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            text-align: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .action-icon {
            font-size: 24px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-card {
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: block;
        }

        .task-item:hover {
            background: #f0f4ff;
            transform: translateX(4px);
        }

        .task-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
        }

        .task-status {
            padding: 2px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 11px;
        }

        .task-status.completed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .task-status.in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        /* äº”è¡Œèƒ½é‡æ¡ */
        .wuxing-bar {
            margin-bottom: 12px;
        }

        .wuxing-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .wuxing-progress {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .wuxing-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .wuxing-fire { background: linear-gradient(90deg, #ff6b6b, #ff2e63); }
        .wuxing-metal { background: linear-gradient(90deg, #ffd93d, #f9ca24); }
        .wuxing-wood { background: linear-gradient(90deg, #6bff92, #06d6a0); }
        .wuxing-water { background: linear-gradient(90deg, #00d9ff, #4facfe); }
        .wuxing-earth { background: linear-gradient(90deg, #c77dff, #9d4edd); }

        /* å€™é€‰è€…åˆ—è¡¨ */
        .candidate-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .candidate-info {
            flex: 1;
        }

        .candidate-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .candidate-meta {
            font-size: 13px;
            color: #666;
        }

        .candidate-actions {
            display: flex;
            gap: 8px;
        }

        .btn-approve, .btn-reject {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .btn-approve {
            background: #4caf50;
            color: white;
        }

        .btn-approve:hover {
            opacity: 0.9;
        }

        .btn-reject {
            background: #f44336;
            color: white;
        }

        .btn-reject:hover {
            opacity: 0.9;
        }

        /* æ¨èä»»åŠ¡æ ·å¼ */
        .recommended-tasks-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .recommended-tasks-card .card-title {
            color: white;
        }

        .recommendation-badge {
            font-size: 11px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            margin-left: auto;
            font-weight: normal;
        }

        .recommended-tasks-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .recommended-task-card {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: block;
        }

        .recommended-task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .rec-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .rec-task-title {
            font-weight: 600;
            color: #333;
            flex: 1;
            margin-right: 10px;
            line-height: 1.3;
        }

        .match-score {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }

        .growth-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        .rec-task-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .rec-task-meta span {
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .rec-empty-state {
            text-align: center;
            padding: 30px;
            color: rgba(255,255,255,0.8);
        }

        .recommended-tasks-card .loading {
            color: rgba(255,255,255,0.8);
        }

        .recommended-tasks-card .spinner {
            border-color: rgba(255,255,255,0.3);
            border-top-color: white;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="topbar">
            <div class="topbar-left">
                <div class="logo">è¶…åä½“</div>
                <nav class="navbar-nav">
                    <a href="/dashboard.html" class="nav-link active">å·¥ä½œå°</a>
                    <a href="/task-create.html" class="nav-link">åˆ›å»ºä»»åŠ¡</a>
                    <a href="/my-tasks.html" class="nav-link">æˆ‘çš„ä»»åŠ¡</a>
                    <a href="/crystal-library.html" class="nav-link">æ™¶ä½“åº“</a>
                    <a href="/members.html" class="nav-link">æˆå‘˜</a>
                    <a href="/profile.html" class="nav-link">ç”»åƒ</a>
                </nav>
                <div style="display: flex; align-items: center; gap: 6px; margin-left: 16px; padding: 6px 12px; background: #f0f4ff; border-radius: 8px;">
                    <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span>
                    <span style="font-size: 13px; color: #666;"><span class="online-count">0</span> äººåœ¨çº¿</span>
                </div>
            </div>
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="username" id="username">åŠ è½½ä¸­...</div>
                    <div class="points" style="cursor: pointer;" onclick="window.location.href='/member-detail.html?id=' + getUser()?.id + '&type=community'" title="ç‚¹å‡»æŸ¥çœ‹ä¸ªäººè¯¦æƒ…">
                        ç§¯åˆ†ï¼š<span class="points-value" id="pointsBalance">--</span>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œåŒº -->
        <div class="grid">
            <div class="card">
                <div class="card-title">
                    <span class="card-icon">âš¡</span>
                    å¿«é€Ÿæ“ä½œ
                </div>
                <div class="quick-actions">
                    <a class="action-btn" href="/task-create.html">
                        <span class="action-icon">ğŸ“</span>
                        <span>åˆ›å»ºä»»åŠ¡</span>
                    </a>
                    <a class="action-btn" href="/my-tasks.html">
                        <span class="action-icon">ğŸ“‹</span>
                        <span>æˆ‘çš„ä»»åŠ¡</span>
                    </a>
                    <button class="action-btn" onclick="issueTicketDialog()">
                        <span class="action-icon">ğŸ«</span>
                        <span>å‘é—¨ç¥¨</span>
                    </button>
                    <a class="action-btn" href="/members.html">
                        <span class="action-icon">ğŸ‘¥</span>
                        <span>æŸ¥çœ‹æˆå‘˜</span>
                    </a>
                    <button class="action-btn" onclick="checkWuxingBalance()">
                        <span class="action-icon">â˜¯ï¸</span>
                        <span>äº”è¡Œå¹³è¡¡</span>
                    </button>
                    <a class="action-btn" href="/crystal-library.html">
                        <span class="action-icon">ğŸ’¡</span>
                        <span>æµè§ˆæ™¶ä½“</span>
                    </a>
                    <a class="action-btn" href="/profile.html">
                        <span class="action-icon">ğŸ¨</span>
                        <span>å¡«å†™ç”»åƒ</span>
                    </a>
                    <a class="action-btn admin-only" href="/admin.html" id="adminPanelBtn" style="display: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <span class="action-icon">&#9881;</span>
                        <span>ç®¡ç†åå°</span>
                    </a>
                </div>
            </div>

            <!-- ç»Ÿè®¡æ•°æ® -->
            <div class="card stat-card">
                <div class="card-title">
                    <span class="card-icon">ğŸ“‹</span>
                    æˆ‘çš„ä»»åŠ¡
                </div>
                <div class="stat-value" id="myTaskCount">--</div>
                <div class="stat-label">è¿›è¡Œä¸­çš„ä»»åŠ¡</div>
            </div>

            <div class="card stat-card">
                <div class="card-title">
                    <span class="card-icon">ğŸ‘¥</span>
                    å›¢é˜Ÿæˆå‘˜
                </div>
                <div class="stat-value" id="memberCount">--</div>
                <div class="stat-label">å·²æ³¨å†Œæˆå‘˜</div>
            </div>

            <div class="card stat-card" onclick="window.location.href='/crystal-library.html'" style="cursor: pointer;">
                <div class="card-title">
                    <span class="card-icon">ğŸ’</span>
                    æˆ‘çš„æ™¶ä½“
                </div>
                <div class="stat-value" id="myCrystalCount">--</div>
                <div class="stat-label">å·²å‡ç»“æ™¶ä½“</div>
            </div>

            <div class="card stat-card" onclick="window.location.href='/projects.html'" style="cursor: pointer;">
                <div class="card-title">
                    <span class="card-icon">ğŸš€</span>
                    æˆ‘çš„é¡¹ç›®
                </div>
                <div class="stat-value" id="myProjectCount">--</div>
                <div class="stat-label">å‚ä¸çš„é¡¹ç›®</div>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜ä¸“ç”¨ï¼šå€™é€‰è€…ç®¡ç† -->
        <div class="grid" id="adminPanel" style="display: none;">
            <div class="card" style="grid-column: span 2;">
                <div class="card-title">
                    <span class="card-icon">ğŸ›¡ï¸</span>
                    å€™é€‰è€…ç®¡ç†ï¼ˆç®¡ç†å‘˜ï¼‰
                </div>
                <div id="candidatesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        æ­£åœ¨åŠ è½½å€™é€‰è€…...
                    </div>
                </div>
            </div>

            <!-- AIæˆå‘˜ç®¡ç† -->
            <div class="card" id="aiMembersCard">
                <div class="card-title">
                    <span class="card-icon">ğŸ¤–</span>
                    AIæˆå‘˜ç®¡ç†
                </div>
                <div class="ai-create-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                    <button onclick="createAIMember('code_master')" class="ai-type-btn" style="padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; transition: transform 0.2s;">
                        <div style="font-size: 20px; margin-bottom: 4px;">ğŸ’»</div>
                        <div style="font-weight: 600;">CodeMaster</div>
                        <div style="font-size: 11px; opacity: 0.8;">ä»£ç å¼€å‘</div>
                    </button>
                    <button onclick="createAIMember('doc_writer')" class="ai-type-btn" style="padding: 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; transition: transform 0.2s;">
                        <div style="font-size: 20px; margin-bottom: 4px;">ğŸ“</div>
                        <div style="font-weight: 600;">DocWriter</div>
                        <div style="font-size: 11px; opacity: 0.8;">æ–‡æ¡£æ’°å†™</div>
                    </button>
                    <button onclick="createAIMember('analyst')" class="ai-type-btn" style="padding: 12px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; transition: transform 0.2s;">
                        <div style="font-size: 20px; margin-bottom: 4px;">ğŸ“Š</div>
                        <div style="font-weight: 600;">Analyst</div>
                        <div style="font-size: 11px; opacity: 0.8;">æ•°æ®åˆ†æ</div>
                    </button>
                    <button onclick="createAIMember('coordinator')" class="ai-type-btn" style="padding: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; transition: transform 0.2s;">
                        <div style="font-size: 20px; margin-bottom: 4px;">ğŸ¯</div>
                        <div style="font-weight: 600;">Coordinator</div>
                        <div style="font-size: 11px; opacity: 0.8;">é¡¹ç›®åè°ƒ</div>
                    </button>
                </div>
                <div id="aiMembersList" style="max-height: 200px; overflow-y: auto;">
                    <div class="loading" style="padding: 20px;">
                        <div class="spinner"></div>
                        åŠ è½½AIæˆå‘˜...
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸ºä½ æ¨èä»»åŠ¡ -->
        <div class="grid" id="recommendedTasksSection" style="display: none;">
            <div class="card recommended-tasks-card" style="grid-column: span 3;">
                <div class="card-title">
                    <span class="card-icon">ğŸ¯</span>
                    ä¸ºä½ æ¨è
                    <span class="recommendation-badge">AIæ™ºèƒ½åŒ¹é…</span>
                </div>
                <div id="recommendedTasksList" class="recommended-tasks-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        æ­£åœ¨åˆ†æåŒ¹é…åº¦...
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ & äº”è¡Œåˆ†æ -->
        <div class="grid">
            <div class="card" style="grid-column: span 2;">
                <div class="card-title">
                    <span class="card-icon">ğŸ“Œ</span>
                    æœ€è¿‘ä»»åŠ¡
                </div>
                <div id="taskList" class="task-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        æ­£åœ¨åŠ è½½ä»»åŠ¡...
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span class="card-icon">â˜¯ï¸</span>
                    äº”è¡Œèƒ½é‡
                </div>
                <div id="wuxingEnergy">
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>ğŸ”¥ ç«</span>
                            <span id="firePercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-fire" id="fireFill" style="width: 20%"></div>
                        </div>
                    </div>
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>âš™ï¸ é‡‘</span>
                            <span id="metalPercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-metal" id="metalFill" style="width: 20%"></div>
                        </div>
                    </div>
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>ğŸŒ³ æœ¨</span>
                            <span id="woodPercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-wood" id="woodFill" style="width: 20%"></div>
                        </div>
                    </div>
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>ğŸ’§ æ°´</span>
                            <span id="waterPercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-water" id="waterFill" style="width: 20%"></div>
                        </div>
                    </div>
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>ğŸ”ï¸ åœŸ</span>
                            <span id="earthPercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-earth" id="earthFill" style="width: 20%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!isLoggedIn()) {
            window.location.href = '/login.html';
        }

        // å…¨å±€çŠ¶æ€
        let userStatus = null;
        let userRole = null;
        let aiEvaluation = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await checkUserStatus();
            await loadDashboardData();

            // å¦‚æœæ˜¯æ­£å¼æˆå‘˜ï¼ŒåŠ è½½æ¨èä»»åŠ¡
            if (userStatus === 'member') {
                await loadRecommendedTasks();
            }

            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†åå°å…¥å£å’ŒåŠ è½½å€™é€‰è€…åˆ—è¡¨
            if (userRole === 'admin') {
                document.getElementById('adminPanel').style.display = 'grid';
                document.getElementById('adminPanelBtn').style.display = 'flex';
                await loadCandidates();
            }
        });

        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼ˆå€™é€‰è€… vs æ­£å¼æˆå‘˜ï¼‰
        async function checkUserStatus() {
            try {
                const response = await authFetch('/api/my/status');
                const data = await response.json();

                if (data.success) {
                    userStatus = data.user.status;
                    userRole = data.user.role || 'member';
                    aiEvaluation = data.evaluation;

                    // å¦‚æœæ˜¯å€™é€‰è€…ï¼Œæ˜¾ç¤ºæç¤ºæ¨ªå¹…
                    if (userStatus === 'candidate') {
                        showCandidateBanner();
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå€™é€‰è€…æ¨ªå¹…
        function showCandidateBanner() {
            const topbar = document.querySelector('.topbar');
            const banner = document.createElement('div');
            banner.style.cssText = `
                background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
                padding: 12px 24px;
                margin-bottom: 20px;
                border-radius: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            `;

            const aiScore = aiEvaluation?.score || 0;
            const progress = Math.min(Math.floor((aiScore / 80) * 100), 100);

            banner.innerHTML = `
                <div>
                    <strong style="font-size: 15px; color: #333;">ğŸ« è§‚å¯Ÿè€…æ¨¡å¼</strong>
                    <div style="font-size: 13px; color: #666; margin-top: 4px;">
                        AIè¯„ä¼°è¿›åº¦ï¼š${aiScore}/80åˆ† (${progress}%) ${progress >= 100 ? '- å³å°†æ”¶åˆ°é‚€è¯·ï¼' : ''}
                    </div>
                </div>
                ${aiScore >= 80 ? `
                    <button onclick="acceptInvitation()" style="
                        padding: 8px 16px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                    ">æ¥å—AIé‚€è¯·</button>
                ` : ''}
            `;

            topbar.parentNode.insertBefore(banner, topbar.nextSibling);
        }

        // æ¥å—AIé‚€è¯·
        async function acceptInvitation() {
            if (!confirm('ç¡®è®¤æ¥å—AIé‚€è¯·ï¼Œæ­£å¼åŠ å…¥è¶…åä½“ï¼Ÿ')) return;

            try {
                const response = await authFetch('/api/ai/accept-invitation', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('ğŸ‰ ' + data.message + '\n\nä½ çš„è¶…åä½“åºå·ï¼š#' + data.member.serialNumber);
                    location.reload();
                } else {
                    alert('æ¥å—é‚€è¯·å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æ¥å—é‚€è¯·å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            const user = getUser();
            if (user) {
                document.getElementById('username').textContent = user.username;
                document.getElementById('pointsBalance').textContent = user.pointsBalance;
                document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();
            }
        }

        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboardData() {
            try {
                // è°ƒç”¨MCP APIè·å–ä»»åŠ¡æ•°æ®
                const tasksResponse = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'list_all_tasks',
                        arguments: {}
                    })
                });

                // æ£€æŸ¥æ˜¯å¦æ˜¯å€™é€‰è€…æƒé™ä¸è¶³
                if (tasksResponse.status === 403) {
                    showCandidateView();
                    return;
                }

                const tasksData = await tasksResponse.json();

                // è°ƒç”¨MCP APIè·å–æˆå‘˜æ•°æ®
                const membersResponse = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'list_all_members',
                        arguments: {}
                    })
                });
                const membersData = await membersResponse.json();

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                const tasks = tasksData.content?.[0]?.text ? JSON.parse(tasksData.content[0].text).tasks || [] : [];
                const members = membersData.content?.[0]?.text ? JSON.parse(membersData.content[0].text).members || [] : [];

                const myTasks = tasks.filter(t => t.status === 'in_progress' || t.status === 'pending');
                document.getElementById('myTaskCount').textContent = myTasks.length;
                document.getElementById('memberCount').textContent = members.length;

                // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                renderTaskList(tasks.slice(0, 5)); // æ˜¾ç¤ºæœ€è¿‘5ä¸ªä»»åŠ¡

                // æ›´æ–°äº”è¡Œèƒ½é‡
                updateWuxingEnergy(tasks, members);

                // åŠ è½½æˆ‘çš„æ–¹æ¡ˆæ•°é‡
                loadMyCrystalsCount();

                // åŠ è½½æˆ‘çš„é¡¹ç›®æ•°é‡
                loadMyProjectsCount();

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('myTaskCount').textContent = '0';
                document.getElementById('memberCount').textContent = '0';
                document.getElementById('mySolutionCount').textContent = '0';
                document.getElementById('taskList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>æš‚æ— æ•°æ®</div>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºå€™é€‰è€…è§†å›¾ï¼ˆæƒé™å—é™ï¼‰
        function showCandidateView() {
            document.getElementById('myTaskCount').textContent = '--';
            document.getElementById('memberCount').textContent = '--';

            document.getElementById('taskList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ”’</div>
                    <div>è§‚å¯Ÿè€…æ¨¡å¼</div>
                    <div style="font-size: 13px; margin-top: 8px; color: #888;">
                        å®Œå–„ä½ çš„äº”è¡Œç”»åƒï¼Œç­‰å¾…AIè¯„ä¼°åå¯è§£é”å…¨éƒ¨åŠŸèƒ½
                    </div>
                    <a href="/profile.html" style="display: inline-block; margin-top: 16px; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                        å¡«å†™äº”è¡Œç”»åƒ
                    </a>
                </div>
            `;

            // ç¦ç”¨éœ€è¦æˆå‘˜æƒé™çš„å¿«é€Ÿæ“ä½œæŒ‰é’®
            document.querySelectorAll('.action-btn').forEach(btn => {
                const href = btn.getAttribute('href');
                // ç”»åƒé¡µé¢ä¿æŒå¯ç”¨
                if (href === '/profile.html') return;

                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';

                if (btn.tagName === 'A') {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        alert('æ­¤åŠŸèƒ½ä»…å¯¹æ­£å¼æˆå‘˜å¼€æ”¾\n\næç¤ºï¼šå®Œå–„äº”è¡Œç”»åƒå¯æé«˜AIè¯„ä¼°åˆ†æ•°');
                    });
                } else {
                    const originalOnclick = btn.getAttribute('onclick');
                    btn.setAttribute('data-original-onclick', originalOnclick);
                    btn.setAttribute('onclick', 'alert("æ­¤åŠŸèƒ½ä»…å¯¹æ­£å¼æˆå‘˜å¼€æ”¾\\n\\næç¤ºï¼šå®Œå–„äº”è¡Œç”»åƒå¯æé«˜AIè¯„ä¼°åˆ†æ•°")');
                }
            });
        }

        // ========================================
        // æ™ºèƒ½æ¨èä»»åŠ¡
        // ========================================

        // åŠ è½½æ¨èä»»åŠ¡
        async function loadRecommendedTasks() {
            try {
                const response = await authFetch('/api/tasks/recommended');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('recommendedTasksSection').style.display = 'grid';
                    renderRecommendedTasks(data.recommendations);
                } else {
                    console.error('è·å–æ¨èä»»åŠ¡å¤±è´¥:', data.message);
                }
            } catch (error) {
                console.error('Failed to load recommended tasks:', error);
            }
        }

        // æ¸²æŸ“æ¨èä»»åŠ¡
        function renderRecommendedTasks(recommendations) {
            const container = document.getElementById('recommendedTasksList');

            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = `
                    <div class="rec-empty-state">
                        <div style="font-size: 36px; margin-bottom: 12px;">ğŸ“­</div>
                        <div>æš‚æ— å¾…åˆ†é…ä»»åŠ¡</div>
                        <div style="font-size: 13px; margin-top: 8px; opacity: 0.7;">
                            æ‰€æœ‰ä»»åŠ¡éƒ½å·²åˆ†é…ï¼Œæˆ–è€…è¿˜æ²¡æœ‰åˆ›å»ºä»»åŠ¡
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = recommendations.map(rec => {
                const { task, score, reasons } = rec;

                // æˆé•¿ä»»åŠ¡æ ‡è¯†ï¼ˆæˆé•¿ä»·å€¼ > 50ï¼‰
                let growthBadge = '';
                if (reasons.growthValue > 50) {
                    growthBadge = '<span class="growth-badge">æˆé•¿ä»»åŠ¡</span>';
                }

                // äº”è¡Œå›¾æ ‡æ˜ å°„
                const wuxingIcons = { 'ç«': 'ğŸ”¥', 'é‡‘': 'âš™ï¸', 'æœ¨': 'ğŸŒ³', 'æ°´': 'ğŸ’§', 'åœŸ': 'ğŸ”ï¸' };
                const wuxingIcon = task.wuxing ? wuxingIcons[task.wuxing] || 'â˜¯ï¸' : '';

                return `
                    <a class="recommended-task-card" href="/task-detail.html?id=${task.id}">
                        <div class="rec-task-header">
                            <div class="rec-task-title">
                                ${escapeHtml(task.title)}
                                ${growthBadge}
                            </div>
                            <span class="match-score">${score}%</span>
                        </div>
                        <div class="rec-task-meta">
                            <span>äº”è¡ŒåŒ¹é… ${reasons.wuxingMatch}%</span>
                            <span>æŠ€èƒ½åŒ¹é… ${reasons.skillMatch}%</span>
                            ${task.wuxing ? `<span>${wuxingIcon} ${task.wuxing}</span>` : ''}
                            <span>ğŸ ${task.reward_points || 20}ç§¯åˆ†</span>
                        </div>
                    </a>
                `;
            }).join('');
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList(tasks) {
            const taskListEl = document.getElementById('taskList');

            if (!tasks || tasks.length === 0) {
                taskListEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>æš‚æ— ä»»åŠ¡</div>
                        <div style="font-size: 13px; margin-top: 8px;">ç‚¹å‡»"åˆ›å»ºä»»åŠ¡"å¼€å§‹åä½œ</div>
                    </div>
                `;
                return;
            }

            const statusMap = {
                'pending': { class: '', label: 'å¾…åˆ†é…' },
                'in_progress': { class: 'in-progress', label: 'è¿›è¡Œä¸­' },
                'completed': { class: 'completed', label: 'å·²å®Œæˆ' }
            };

            taskListEl.innerHTML = tasks.map(task => {
                const status = statusMap[task.status] || statusMap['pending'];
                return `
                    <a class="task-item" href="/task-detail.html?id=${task.id}">
                        <div class="task-title">${escapeHtml(task.title)}</div>
                        <div class="task-meta">
                            <span class="task-status ${status.class}">${status.label}</span>
                            ${task.wuxing ? `<span>â˜¯ï¸ ${task.wuxing}</span>` : ''}
                            ${task.assigned_to_name ? `<span>ğŸ‘¤ ${escapeHtml(task.assigned_to_name)}</span>` : '<span style="color:#f57c00">æœªåˆ†é…</span>'}
                            <span>ğŸ ${task.reward_points || 20}ç§¯åˆ†</span>
                        </div>
                    </a>
                `;
            }).join('');

            // æ·»åŠ æŸ¥çœ‹æ›´å¤šé“¾æ¥
            if (tasks.length >= 5) {
                taskListEl.innerHTML += `
                    <a href="/my-tasks.html" style="text-align: center; padding: 12px; color: #667eea; font-size: 14px;">
                        æŸ¥çœ‹å…¨éƒ¨ä»»åŠ¡ â†’
                    </a>
                `;
            }
        }

        // æ›´æ–°äº”è¡Œèƒ½é‡åˆ†å¸ƒ
        function updateWuxingEnergy(tasks, members) {
            // è®¡ç®—äº”è¡Œèƒ½é‡åˆ†å¸ƒ
            const wuxingCount = { fire: 0, metal: 0, wood: 0, water: 0, earth: 0 };
            const wuxingMap = { 'ç«': 'fire', 'é‡‘': 'metal', 'æœ¨': 'wood', 'æ°´': 'water', 'åœŸ': 'earth' };

            members.forEach(member => {
                const mainWuxing = wuxingMap[member.mainWuxing];
                if (mainWuxing) wuxingCount[mainWuxing]++;
            });

            const total = Math.max(members.length, 1);
            const updateBar = (id, count) => {
                const percent = Math.round((count / total) * 100);
                document.getElementById(`${id}Percent`).textContent = `${percent}%`;
                document.getElementById(`${id}Fill`).style.width = `${percent}%`;
            };

            updateBar('fire', wuxingCount.fire);
            updateBar('metal', wuxingCount.metal);
            updateBar('wood', wuxingCount.wood);
            updateBar('water', wuxingCount.water);
            updateBar('earth', wuxingCount.earth);
        }

        // å¿«é€Ÿæ“ä½œå‡½æ•°
        async function checkWuxingBalance() {
            try {
                const response = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'check_wuxing_balance',
                        arguments: {}
                    })
                });

                const data = await response.json();
                if (data.content?.[0]?.text) {
                    const balance = JSON.parse(data.content[0].text);

                    let message = 'â˜¯ï¸ äº”è¡Œå¹³è¡¡åˆ†æ\n\n';
                    message += `ç«: ${balance.distribution.fire} (${balance.percentages.fire}%)\n`;
                    message += `é‡‘: ${balance.distribution.metal} (${balance.percentages.metal}%)\n`;
                    message += `æœ¨: ${balance.distribution.wood} (${balance.percentages.wood}%)\n`;
                    message += `æ°´: ${balance.distribution.water} (${balance.percentages.water}%)\n`;
                    message += `åœŸ: ${balance.distribution.earth} (${balance.percentages.earth}%)\n`;
                    message += `\nå¹³è¡¡çŠ¶æ€: ${balance.isBalanced ? 'âœ… å¹³è¡¡' : 'âš ï¸ ä¸å¹³è¡¡'}\n`;

                    if (balance.recommendations?.length > 0) {
                        message += `\nå»ºè®®:\n${balance.recommendations.join('\n')}`;
                    }

                    alert(message);
                }
            } catch (error) {
                console.error('äº”è¡Œå¹³è¡¡æ£€æŸ¥å¤±è´¥:', error);
                alert('äº”è¡Œå¹³è¡¡æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å‘æ”¾é—¨ç¥¨ï¼ˆæ­£å¼æˆå‘˜æ‰èƒ½ä½¿ç”¨ï¼‰
        async function issueTicketDialog() {
            if (userStatus === 'candidate') {
                alert('æ­¤åŠŸèƒ½ä»…å¯¹æ­£å¼æˆå‘˜å¼€æ”¾');
                return;
            }

            const recipientEmail = prompt('è¯·è¾“å…¥æ¥æ”¶è€…çš„é‚®ç®±ï¼š');
            if (!recipientEmail) return;

            // ç®€å•çš„é‚®ç®±éªŒè¯
            if (!recipientEmail.includes('@')) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }

            try {
                const response = await authFetch('/api/ticket/issue', {
                    method: 'POST',
                    body: JSON.stringify({ recipientEmail })
                });

                const data = await response.json();

                if (data.success) {
                    const ticketUrl = data.ticketUrl;
                    alert(`âœ… é—¨ç¥¨å‘æ”¾æˆåŠŸï¼\n\næ¥æ”¶è€…ï¼š${recipientEmail}\n\né—¨ç¥¨é“¾æ¥ï¼š\n${ticketUrl}\n\nè¯·å°†æ­¤é“¾æ¥å‘é€ç»™å¯¹æ–¹ã€‚`);

                    // å¯é€‰ï¼šå¤åˆ¶åˆ°å‰ªè´´æ¿
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(ticketUrl);
                        console.log('é—¨ç¥¨é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }
                } else {
                    alert('å‘æ”¾å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('å‘æ”¾é—¨ç¥¨å¤±è´¥:', error);
                alert('å‘æ”¾é—¨ç¥¨å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ========================================
        // ç§¯åˆ†ç³»ç»Ÿ
        // ========================================

        // æŸ¥çœ‹ç§¯åˆ†å†å²
        async function viewPointsHistory() {
            try {
                const response = await authFetch('/api/points/history?limit=10');
                const data = await response.json();

                if (data.success) {
                    let message = `ğŸ’° ç§¯åˆ†å†å²ï¼ˆå½“å‰ä½™é¢ï¼š${data.balance}ï¼‰\n\n`;

                    if (data.transactions.length === 0) {
                        message += 'æš‚æ— äº¤æ˜“è®°å½•';
                    } else {
                        data.transactions.forEach(tx => {
                            const date = new Date(tx.createdAt).toLocaleDateString();
                            const sign = tx.amount > 0 ? '+' : '';
                            message += `${date} ${sign}${tx.amount}ç§¯åˆ†\n`;
                            message += `  ${tx.description}\n\n`;
                        });
                    }

                    alert(message);
                } else {
                    alert('åŠ è½½å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æŸ¥çœ‹ç§¯åˆ†å†å²å¤±è´¥:', error);
                alert('æŸ¥çœ‹ç§¯åˆ†å†å²å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜åŠŸèƒ½
        // ========================================

        // åŠ è½½å€™é€‰è€…åˆ—è¡¨
        async function loadCandidates() {
            try {
                const response = await authFetch('/api/admin/candidates');
                const data = await response.json();

                if (data.success) {
                    renderCandidates(data.candidates);
                } else {
                    document.getElementById('candidatesList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">âŒ</div>
                            <div>åŠ è½½å¤±è´¥ï¼š${data.message}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½å€™é€‰è€…å¤±è´¥:', error);
                document.getElementById('candidatesList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <div>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“å€™é€‰è€…åˆ—è¡¨
        function renderCandidates(candidates) {
            const listEl = document.getElementById('candidatesList');

            if (!candidates || candidates.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âœ…</div>
                        <div>æš‚æ— å¾…å®¡æ ¸å€™é€‰è€…</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = candidates.map(candidate => {
                const joinedDate = new Date(candidate.createdAt).toLocaleDateString();
                return `
                    <div class="candidate-item">
                        <div class="candidate-info">
                            <div class="candidate-name">${candidate.username}</div>
                            <div class="candidate-meta">
                                ğŸ“§ ${candidate.email} | ğŸ“… ${joinedDate}
                            </div>
                        </div>
                        <div class="candidate-actions">
                            <button class="btn-approve" onclick="approveCandidate('${candidate.id}', '${candidate.username}')">
                                âœ… æ‰¹å‡†
                            </button>
                            <button class="btn-reject" onclick="rejectCandidate('${candidate.id}', '${candidate.username}')">
                                âŒ æ‹’ç»
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ‰¹å‡†å€™é€‰è€…
        async function approveCandidate(candidateId, candidateName) {
            if (!confirm(`ç¡®è®¤æ‰¹å‡† ${candidateName} åŠ å…¥è¶…åä½“ï¼Ÿ`)) return;

            try {
                const response = await authFetch('/api/admin/approve-candidate', {
                    method: 'POST',
                    body: JSON.stringify({ candidateId })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… å·²æ‰¹å‡† ${candidateName}ï¼\n\nè¶…åä½“åºå·ï¼š#${data.member.serialNumber}`);
                    await loadCandidates(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('æ‰¹å‡†å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æ‰¹å‡†å€™é€‰è€…å¤±è´¥:', error);
                alert('æ‰¹å‡†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ‹’ç»å€™é€‰è€…
        async function rejectCandidate(candidateId, candidateName) {
            const reason = prompt(`ç¡®è®¤æ‹’ç» ${candidateName}ï¼Ÿ\n\nè¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼ˆå¯é€‰ï¼‰ï¼š`);
            if (reason === null) return; // ç”¨æˆ·å–æ¶ˆ

            try {
                const response = await authFetch('/api/admin/reject-candidate', {
                    method: 'POST',
                    body: JSON.stringify({ candidateId, reason })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`å·²æ‹’ç» ${candidateName}`);
                    await loadCandidates(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('æ‹’ç»å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æ‹’ç»å€™é€‰è€…å¤±è´¥:', error);
                alert('æ‹’ç»å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ========================================
        // AIæˆå‘˜ç®¡ç†
        // ========================================

        // åˆ›å»ºAIæˆå‘˜
        async function createAIMember(aiType) {
            const typeNames = {
                'code_master': 'CodeMaster AI',
                'doc_writer': 'DocWriter AI',
                'analyst': 'Analyst AI',
                'coordinator': 'Coordinator AI'
            };

            if (!confirm(`ç¡®è®¤åˆ›å»º ${typeNames[aiType]} å—ï¼Ÿ`)) return;

            try {
                const response = await authFetch('/api/ai-members/create', {
                    method: 'POST',
                    body: JSON.stringify({ aiType })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`${data.aiMember.username} åˆ›å»ºæˆåŠŸï¼åºå·ï¼š#${String(data.aiMember.serialNumber).padStart(3, '0')}`);
                    loadAIMembers();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Failed to create AI member:', error);
                alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åŠ è½½AIæˆå‘˜åˆ—è¡¨
        async function loadAIMembers() {
            try {
                const response = await authFetch('/api/ai-members');
                const data = await response.json();

                if (data.success) {
                    renderAIMembers(data.aiMembers);
                }
            } catch (error) {
                console.error('Failed to load AI members:', error);
                document.getElementById('aiMembersList').innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }

        // æ¸²æŸ“AIæˆå‘˜åˆ—è¡¨
        function renderAIMembers(aiMembers) {
            const container = document.getElementById('aiMembersList');

            if (!aiMembers || aiMembers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        æš‚æ— AIæˆå‘˜ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»º
                    </div>
                `;
                return;
            }

            const typeIcons = {
                'code_master': 'ğŸ’»',
                'doc_writer': 'ğŸ“',
                'analyst': 'ğŸ“Š',
                'coordinator': 'ğŸ¯'
            };

            container.innerHTML = aiMembers.map(ai => `
                <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 10px; margin-bottom: 8px;">
                    <div style="font-size: 24px; margin-right: 12px;">${typeIcons[ai.aiType] || 'ğŸ¤–'}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">#${String(ai.serialNumber).padStart(3, '0')} ${escapeHtml(ai.username)}</div>
                        <div style="font-size: 12px; color: #666;">${ai.pwpProfile?.skills?.slice(0, 2).join(', ') || ''}</div>
                    </div>
                    <a href="/member-detail.html?id=${ai.id}&type=community" style="padding: 6px 12px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-size: 12px;">
                        è¯¦æƒ…
                    </a>
                </div>
            `).join('');
        }

        // åŠ è½½æˆ‘çš„æ–¹æ¡ˆæ•°é‡
        async function loadMyCrystalsCount() {
            try {
                const user = getUser();
                const response = await authFetch(`/api/solutions?authorId=${user.id}&status=published`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('mySolutionCount').textContent = data.pagination.total;
                } else {
                    document.getElementById('mySolutionCount').textContent = '0';
                }
            } catch (error) {
                console.error('åŠ è½½æ–¹æ¡ˆæ•°é‡å¤±è´¥:', error);
                document.getElementById('mySolutionCount').textContent = '0';
            }
        }

        // åŠ è½½æˆ‘çš„é¡¹ç›®æ•°é‡
        async function loadMyProjectsCount() {
            try {
                const response = await authFetch('/api/projects?myProjects=true');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('myProjectCount').textContent = data.pagination.total;
                } else {
                    document.getElementById('myProjectCount').textContent = '0';
                }
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®æ•°é‡å¤±è´¥:', error);
                document.getElementById('myProjectCount').textContent = '0';
            }
        }

        // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœæ˜¯ç®¡ç†å‘˜åˆ™åŠ è½½AIæˆå‘˜
        document.addEventListener('DOMContentLoaded', () => {
            // å»¶è¿ŸåŠ è½½AIæˆå‘˜ï¼ˆç­‰å¾…ç”¨æˆ·è§’è‰²ç¡®è®¤ï¼‰
            setTimeout(() => {
                if (userRole === 'admin') {
                    loadAIMembers();
                }
            }, 500);

            // WebSocketå®æ—¶æ›´æ–°é›†æˆ
            setupWebSocketListeners();
        });

        // ========================================
        // WebSocketå®æ—¶åä½œ
        // ========================================

        function setupWebSocketListeners() {
            if (!window.wsClient) {
                console.warn('[Dashboard] WebSocketå®¢æˆ·ç«¯æœªå°±ç»ª');
                return;
            }

            // ç›‘å¬ä»»åŠ¡çŠ¶æ€å˜æ›´
            wsClient.on('task-status-changed', (data) => {
                console.log('[Dashboard] ä»»åŠ¡çŠ¶æ€æ›´æ–°', data);
                // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                loadDashboardData();
            });

            // ç›‘å¬ä»»åŠ¡åˆ†é…å˜æ›´
            wsClient.on('task-assignment-changed', (data) => {
                console.log('[Dashboard] ä»»åŠ¡åˆ†é…æ›´æ–°', data);
                // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å’Œæ¨èä»»åŠ¡
                loadDashboardData();
                if (userStatus === 'member') {
                    loadRecommendedTasks();
                }
            });

            // ç›‘å¬æ–°ä»»åŠ¡åˆ›å»º
            wsClient.on('task-created', (data) => {
                console.log('[Dashboard] æ–°ä»»åŠ¡åˆ›å»º', data);
                // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                loadDashboardData();
                if (userStatus === 'member') {
                    loadRecommendedTasks();
                }
            });

            // ç›‘å¬åœ¨çº¿ç”¨æˆ·å˜åŒ–
            wsClient.on('user-online', (data) => {
                console.log(`[Dashboard] ç”¨æˆ·ä¸Šçº¿: ${data.username}`);
            });

            wsClient.on('user-offline', (data) => {
                console.log(`[Dashboard] ç”¨æˆ·ä¸‹çº¿: ${data.username}`);
            });

            wsClient.on('online-users-updated', (users) => {
                console.log('[Dashboard] åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ›´æ–°', users);
            });
        }
    </script>

    <script src="/js/pwa.js" defer></script>
</body>
</html>
