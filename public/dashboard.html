<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å·¥ä½œå° - è¶…åä½“</title>
    <script src="/js/auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .topbar {
            background: white;
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .username {
            font-weight: 600;
            color: #333;
        }

        .points {
            font-size: 13px;
            color: #666;
        }

        .points-value {
            color: #ffa726;
            font-weight: 600;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #e0e0e0;
            color: #333;
        }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 20px;
        }

        /* å¿«é€Ÿæ“ä½œå¡ç‰‡ */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .quick-actions {
                grid-template-columns: 1fr 1fr;
            }
        }

        .action-btn {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .action-icon {
            font-size: 24px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-card {
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .task-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
        }

        .task-status {
            padding: 2px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 11px;
        }

        .task-status.completed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .task-status.in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        /* äº”è¡Œèƒ½é‡æ¡ */
        .wuxing-bar {
            margin-bottom: 12px;
        }

        .wuxing-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .wuxing-progress {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .wuxing-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .wuxing-fire { background: linear-gradient(90deg, #ff6b6b, #ff2e63); }
        .wuxing-metal { background: linear-gradient(90deg, #ffd93d, #f9ca24); }
        .wuxing-wood { background: linear-gradient(90deg, #6bff92, #06d6a0); }
        .wuxing-water { background: linear-gradient(90deg, #00d9ff, #4facfe); }
        .wuxing-earth { background: linear-gradient(90deg, #c77dff, #9d4edd); }

        /* å€™é€‰è€…åˆ—è¡¨ */
        .candidate-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .candidate-info {
            flex: 1;
        }

        .candidate-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .candidate-meta {
            font-size: 13px;
            color: #666;
        }

        .candidate-actions {
            display: flex;
            gap: 8px;
        }

        .btn-approve, .btn-reject {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .btn-approve {
            background: #4caf50;
            color: white;
        }

        .btn-approve:hover {
            opacity: 0.9;
        }

        .btn-reject {
            background: #f44336;
            color: white;
        }

        .btn-reject:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="topbar">
            <div class="topbar-left">
                <div class="logo">è¶…åä½“</div>
                <div class="user-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <div class="username" id="username">åŠ è½½ä¸­...</div>
                        <div class="points">
                            ç§¯åˆ†ï¼š<span class="points-value" id="pointsBalance">--</span>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
        </div>

        <!-- å¿«é€Ÿæ“ä½œåŒº -->
        <div class="grid">
            <div class="card">
                <div class="card-title">
                    <span class="card-icon">âš¡</span>
                    å¿«é€Ÿæ“ä½œ
                </div>
                <div class="quick-actions">
                    <button class="action-btn" onclick="createTaskDialog()">
                        <span class="action-icon">ğŸ“</span>
                        <span>åˆ›å»ºä»»åŠ¡</span>
                    </button>
                    <button class="action-btn" onclick="registerMemberDialog()">
                        <span class="action-icon">ğŸ‘¥</span>
                        <span>æ³¨å†Œæˆå‘˜</span>
                    </button>
                    <button class="action-btn" onclick="issueTicketDialog()">
                        <span class="action-icon">ğŸ«</span>
                        <span>å‘é—¨ç¥¨</span>
                    </button>
                    <button class="action-btn" onclick="viewTeamDashboard()">
                        <span class="action-icon">ğŸ“Š</span>
                        <span>å›¢é˜Ÿçœ‹æ¿</span>
                    </button>
                    <button class="action-btn" onclick="checkWuxingBalance()">
                        <span class="action-icon">â˜¯ï¸</span>
                        <span>äº”è¡Œå¹³è¡¡</span>
                    </button>
                    <button class="action-btn" onclick="alert('äº”è¡Œç”»åƒå¡«å†™åŠŸèƒ½å¼€å‘ä¸­...')">
                        <span class="action-icon">ğŸ¨</span>
                        <span>å¡«å†™ç”»åƒ</span>
                    </button>
                </div>
            </div>

            <!-- ç»Ÿè®¡æ•°æ® -->
            <div class="card stat-card">
                <div class="card-title">
                    <span class="card-icon">ğŸ“‹</span>
                    æˆ‘çš„ä»»åŠ¡
                </div>
                <div class="stat-value" id="myTaskCount">--</div>
                <div class="stat-label">è¿›è¡Œä¸­çš„ä»»åŠ¡</div>
            </div>

            <div class="card stat-card">
                <div class="card-title">
                    <span class="card-icon">ğŸ‘¥</span>
                    å›¢é˜Ÿæˆå‘˜
                </div>
                <div class="stat-value" id="memberCount">--</div>
                <div class="stat-label">å·²æ³¨å†Œæˆå‘˜</div>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜ä¸“ç”¨ï¼šå€™é€‰è€…ç®¡ç† -->
        <div class="grid" id="adminPanel" style="display: none;">
            <div class="card" style="grid-column: span 3;">
                <div class="card-title">
                    <span class="card-icon">ğŸ›¡ï¸</span>
                    å€™é€‰è€…ç®¡ç†ï¼ˆç®¡ç†å‘˜ï¼‰
                </div>
                <div id="candidatesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        æ­£åœ¨åŠ è½½å€™é€‰è€…...
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ & äº”è¡Œåˆ†æ -->
        <div class="grid">
            <div class="card" style="grid-column: span 2;">
                <div class="card-title">
                    <span class="card-icon">ğŸ“Œ</span>
                    æœ€è¿‘ä»»åŠ¡
                </div>
                <div id="taskList" class="task-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        æ­£åœ¨åŠ è½½ä»»åŠ¡...
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span class="card-icon">â˜¯ï¸</span>
                    äº”è¡Œèƒ½é‡
                </div>
                <div id="wuxingEnergy">
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>ğŸ”¥ ç«</span>
                            <span id="firePercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-fire" id="fireFill" style="width: 20%"></div>
                        </div>
                    </div>
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>âš™ï¸ é‡‘</span>
                            <span id="metalPercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-metal" id="metalFill" style="width: 20%"></div>
                        </div>
                    </div>
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>ğŸŒ³ æœ¨</span>
                            <span id="woodPercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-wood" id="woodFill" style="width: 20%"></div>
                        </div>
                    </div>
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>ğŸ’§ æ°´</span>
                            <span id="waterPercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-water" id="waterFill" style="width: 20%"></div>
                        </div>
                    </div>
                    <div class="wuxing-bar">
                        <div class="wuxing-label">
                            <span>ğŸ”ï¸ åœŸ</span>
                            <span id="earthPercent">20%</span>
                        </div>
                        <div class="wuxing-progress">
                            <div class="wuxing-fill wuxing-earth" id="earthFill" style="width: 20%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!isLoggedIn()) {
            window.location.href = '/login.html';
        }

        // å…¨å±€çŠ¶æ€
        let userStatus = null;
        let userRole = null;
        let aiEvaluation = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await checkUserStatus();
            await loadDashboardData();

            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼ŒåŠ è½½å€™é€‰è€…åˆ—è¡¨
            if (userRole === 'admin') {
                document.getElementById('adminPanel').style.display = 'grid';
                await loadCandidates();
            }
        });

        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼ˆå€™é€‰è€… vs æ­£å¼æˆå‘˜ï¼‰
        async function checkUserStatus() {
            try {
                const response = await authFetch('/api/my/status');
                const data = await response.json();

                if (data.success) {
                    userStatus = data.user.status;
                    userRole = data.user.role || 'member';
                    aiEvaluation = data.evaluation;

                    // å¦‚æœæ˜¯å€™é€‰è€…ï¼Œæ˜¾ç¤ºæç¤ºæ¨ªå¹…
                    if (userStatus === 'candidate') {
                        showCandidateBanner();
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå€™é€‰è€…æ¨ªå¹…
        function showCandidateBanner() {
            const topbar = document.querySelector('.topbar');
            const banner = document.createElement('div');
            banner.style.cssText = `
                background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
                padding: 12px 24px;
                margin-bottom: 20px;
                border-radius: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            `;

            const aiScore = aiEvaluation?.score || 0;
            const progress = Math.min(Math.floor((aiScore / 80) * 100), 100);

            banner.innerHTML = `
                <div>
                    <strong style="font-size: 15px; color: #333;">ğŸ« è§‚å¯Ÿè€…æ¨¡å¼</strong>
                    <div style="font-size: 13px; color: #666; margin-top: 4px;">
                        AIè¯„ä¼°è¿›åº¦ï¼š${aiScore}/80åˆ† (${progress}%) ${progress >= 100 ? '- å³å°†æ”¶åˆ°é‚€è¯·ï¼' : ''}
                    </div>
                </div>
                ${aiScore >= 80 ? `
                    <button onclick="acceptInvitation()" style="
                        padding: 8px 16px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                    ">æ¥å—AIé‚€è¯·</button>
                ` : ''}
            `;

            topbar.parentNode.insertBefore(banner, topbar.nextSibling);
        }

        // æ¥å—AIé‚€è¯·
        async function acceptInvitation() {
            if (!confirm('ç¡®è®¤æ¥å—AIé‚€è¯·ï¼Œæ­£å¼åŠ å…¥è¶…åä½“ï¼Ÿ')) return;

            try {
                const response = await authFetch('/api/ai/accept-invitation', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('ğŸ‰ ' + data.message + '\n\nä½ çš„è¶…åä½“åºå·ï¼š#' + data.member.serialNumber);
                    location.reload();
                } else {
                    alert('æ¥å—é‚€è¯·å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æ¥å—é‚€è¯·å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            const user = getUser();
            if (user) {
                document.getElementById('username').textContent = user.username;
                document.getElementById('pointsBalance').textContent = user.pointsBalance;
                document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();
            }
        }

        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboardData() {
            try {
                // è°ƒç”¨MCP APIè·å–ä»»åŠ¡æ•°æ®
                const tasksResponse = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'list_all_tasks',
                        arguments: {}
                    })
                });

                // æ£€æŸ¥æ˜¯å¦æ˜¯å€™é€‰è€…æƒé™ä¸è¶³
                if (tasksResponse.status === 403) {
                    showCandidateView();
                    return;
                }

                const tasksData = await tasksResponse.json();

                // è°ƒç”¨MCP APIè·å–æˆå‘˜æ•°æ®
                const membersResponse = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'list_all_members',
                        arguments: {}
                    })
                });
                const membersData = await membersResponse.json();

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                const tasks = tasksData.content?.[0]?.text ? JSON.parse(tasksData.content[0].text).tasks || [] : [];
                const members = membersData.content?.[0]?.text ? JSON.parse(membersData.content[0].text).members || [] : [];

                const myTasks = tasks.filter(t => t.status === 'in_progress' || t.status === 'pending');
                document.getElementById('myTaskCount').textContent = myTasks.length;
                document.getElementById('memberCount').textContent = members.length;

                // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                renderTaskList(tasks.slice(0, 5)); // æ˜¾ç¤ºæœ€è¿‘5ä¸ªä»»åŠ¡

                // æ›´æ–°äº”è¡Œèƒ½é‡
                updateWuxingEnergy(tasks, members);

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('myTaskCount').textContent = '0';
                document.getElementById('memberCount').textContent = '0';
                document.getElementById('taskList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>æš‚æ— æ•°æ®</div>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºå€™é€‰è€…è§†å›¾ï¼ˆæƒé™å—é™ï¼‰
        function showCandidateView() {
            document.getElementById('myTaskCount').textContent = '--';
            document.getElementById('memberCount').textContent = '--';

            document.getElementById('taskList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ğŸ”’</div>
                    <div>è§‚å¯Ÿè€…æ¨¡å¼</div>
                    <div style="font-size: 13px; margin-top: 8px; color: #888;">
                        å®Œå–„ä½ çš„äº”è¡Œç”»åƒï¼Œç­‰å¾…AIè¯„ä¼°åå¯è§£é”å…¨éƒ¨åŠŸèƒ½
                    </div>
                </div>
            `;

            // ç¦ç”¨å¿«é€Ÿæ“ä½œæŒ‰é’®
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                const originalOnclick = btn.getAttribute('onclick');
                btn.setAttribute('data-original-onclick', originalOnclick);
                btn.setAttribute('onclick', 'alert("æ­¤åŠŸèƒ½ä»…å¯¹æ­£å¼æˆå‘˜å¼€æ”¾\\n\\næç¤ºï¼šå®Œå–„äº”è¡Œç”»åƒå¯æé«˜AIè¯„ä¼°åˆ†æ•°")');
            });
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList(tasks) {
            const taskListEl = document.getElementById('taskList');

            if (!tasks || tasks.length === 0) {
                taskListEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>æš‚æ— ä»»åŠ¡</div>
                        <div style="font-size: 13px; margin-top: 8px;">ç‚¹å‡»"åˆ›å»ºä»»åŠ¡"å¼€å§‹åä½œ</div>
                    </div>
                `;
                return;
            }

            const statusMap = {
                'pending': { class: '', label: 'å¾…åˆ†é…' },
                'in_progress': { class: 'in-progress', label: 'è¿›è¡Œä¸­' },
                'completed': { class: 'completed', label: 'å·²å®Œæˆ' }
            };

            taskListEl.innerHTML = tasks.map(task => {
                const status = statusMap[task.status] || statusMap['pending'];
                return `
                    <div class="task-item">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <span class="task-status ${status.class}">${status.label}</span>
                            <span>éœ€æ±‚: ${task.requiredWuxing}</span>
                            ${task.assignedTo ? `<span>ğŸ‘¤ ${task.assignedTo}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°äº”è¡Œèƒ½é‡åˆ†å¸ƒ
        function updateWuxingEnergy(tasks, members) {
            // è®¡ç®—äº”è¡Œèƒ½é‡åˆ†å¸ƒ
            const wuxingCount = { fire: 0, metal: 0, wood: 0, water: 0, earth: 0 };
            const wuxingMap = { 'ç«': 'fire', 'é‡‘': 'metal', 'æœ¨': 'wood', 'æ°´': 'water', 'åœŸ': 'earth' };

            members.forEach(member => {
                const mainWuxing = wuxingMap[member.mainWuxing];
                if (mainWuxing) wuxingCount[mainWuxing]++;
            });

            const total = Math.max(members.length, 1);
            const updateBar = (id, count) => {
                const percent = Math.round((count / total) * 100);
                document.getElementById(`${id}Percent`).textContent = `${percent}%`;
                document.getElementById(`${id}Fill`).style.width = `${percent}%`;
            };

            updateBar('fire', wuxingCount.fire);
            updateBar('metal', wuxingCount.metal);
            updateBar('wood', wuxingCount.wood);
            updateBar('water', wuxingCount.water);
            updateBar('earth', wuxingCount.earth);
        }

        // å¿«é€Ÿæ“ä½œå‡½æ•°
        async function createTaskDialog() {
            const title = prompt('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜ï¼š');
            if (!title) return;

            const description = prompt('è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼š');
            if (!description) return;

            const requiredWuxing = prompt('è¯·è¾“å…¥éœ€è¦çš„äº”è¡Œå±æ€§ï¼ˆç«/é‡‘/æœ¨/æ°´/åœŸï¼‰ï¼š');
            if (!requiredWuxing || !['ç«', 'é‡‘', 'æœ¨', 'æ°´', 'åœŸ'].includes(requiredWuxing)) {
                alert('æ— æ•ˆçš„äº”è¡Œå±æ€§');
                return;
            }

            try {
                const response = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'create_task',
                        arguments: { title, description, requiredWuxing }
                    })
                });

                const data = await response.json();
                if (data.content?.[0]?.text) {
                    const result = JSON.parse(data.content[0].text);
                    alert(`âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼\n\nä»»åŠ¡ID: ${result.task.id}`);
                    await loadDashboardData(); // åˆ·æ–°æ•°æ®
                }
            } catch (error) {
                console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function registerMemberDialog() {
            const name = prompt('è¯·è¾“å…¥æˆå‘˜å§“åï¼š');
            if (!name) return;

            const mainWuxing = prompt('è¯·è¾“å…¥ä¸»äº”è¡Œå±æ€§ï¼ˆç«/é‡‘/æœ¨/æ°´/åœŸï¼‰ï¼š');
            if (!mainWuxing || !['ç«', 'é‡‘', 'æœ¨', 'æ°´', 'åœŸ'].includes(mainWuxing)) {
                alert('æ— æ•ˆçš„äº”è¡Œå±æ€§');
                return;
            }

            const skills = prompt('è¯·è¾“å…¥æŠ€èƒ½ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼š');
            const skillList = skills ? skills.split(',').map(s => s.trim()) : [];

            try {
                const response = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'register_member',
                        arguments: { name, mainWuxing, skills: skillList }
                    })
                });

                const data = await response.json();
                if (data.content?.[0]?.text) {
                    const result = JSON.parse(data.content[0].text);
                    alert(`âœ… æˆå‘˜æ³¨å†ŒæˆåŠŸï¼\n\næˆå‘˜ID: ${result.member.id}\nå§“å: ${result.member.name}\näº”è¡Œ: ${result.member.mainWuxing}`);
                    await loadDashboardData(); // åˆ·æ–°æ•°æ®
                }
            } catch (error) {
                console.error('æ³¨å†Œæˆå‘˜å¤±è´¥:', error);
                alert('æ³¨å†Œæˆå‘˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function viewTeamDashboard() {
            try {
                const response = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'get_team_dashboard',
                        arguments: {}
                    })
                });

                const data = await response.json();
                if (data.content?.[0]?.text) {
                    const dashboard = JSON.parse(data.content[0].text);

                    let message = 'ğŸ“Š å›¢é˜Ÿåä½œçœ‹æ¿\n\n';
                    message += `æ€»ä»»åŠ¡æ•°: ${dashboard.totalTasks}\n`;
                    message += `å·²å®Œæˆ: ${dashboard.completedTasks}\n`;
                    message += `è¿›è¡Œä¸­: ${dashboard.inProgressTasks}\n`;
                    message += `å¾…åˆ†é…: ${dashboard.pendingTasks}\n`;
                    message += `\næ€»æˆå‘˜æ•°: ${dashboard.totalMembers}\n`;
                    message += `æ´»è·ƒæˆå‘˜: ${dashboard.activeMembers}\n`;
                    message += `å¹³å‡ä»»åŠ¡å®Œæˆç‡: ${dashboard.completionRate}%`;

                    alert(message);
                }
            } catch (error) {
                console.error('è·å–å›¢é˜Ÿçœ‹æ¿å¤±è´¥:', error);
                alert('è·å–å›¢é˜Ÿçœ‹æ¿å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function checkWuxingBalance() {
            try {
                const response = await authFetch('/mcp/tools/call', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'check_wuxing_balance',
                        arguments: {}
                    })
                });

                const data = await response.json();
                if (data.content?.[0]?.text) {
                    const balance = JSON.parse(data.content[0].text);

                    let message = 'â˜¯ï¸ äº”è¡Œå¹³è¡¡åˆ†æ\n\n';
                    message += `ç«: ${balance.distribution.fire} (${balance.percentages.fire}%)\n`;
                    message += `é‡‘: ${balance.distribution.metal} (${balance.percentages.metal}%)\n`;
                    message += `æœ¨: ${balance.distribution.wood} (${balance.percentages.wood}%)\n`;
                    message += `æ°´: ${balance.distribution.water} (${balance.percentages.water}%)\n`;
                    message += `åœŸ: ${balance.distribution.earth} (${balance.percentages.earth}%)\n`;
                    message += `\nå¹³è¡¡çŠ¶æ€: ${balance.isBalanced ? 'âœ… å¹³è¡¡' : 'âš ï¸ ä¸å¹³è¡¡'}\n`;

                    if (balance.recommendations?.length > 0) {
                        message += `\nå»ºè®®:\n${balance.recommendations.join('\n')}`;
                    }

                    alert(message);
                }
            } catch (error) {
                console.error('äº”è¡Œå¹³è¡¡æ£€æŸ¥å¤±è´¥:', error);
                alert('äº”è¡Œå¹³è¡¡æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å‘æ”¾é—¨ç¥¨ï¼ˆæ­£å¼æˆå‘˜æ‰èƒ½ä½¿ç”¨ï¼‰
        async function issueTicketDialog() {
            if (userStatus === 'candidate') {
                alert('æ­¤åŠŸèƒ½ä»…å¯¹æ­£å¼æˆå‘˜å¼€æ”¾');
                return;
            }

            const recipientEmail = prompt('è¯·è¾“å…¥æ¥æ”¶è€…çš„é‚®ç®±ï¼š');
            if (!recipientEmail) return;

            // ç®€å•çš„é‚®ç®±éªŒè¯
            if (!recipientEmail.includes('@')) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }

            try {
                const response = await authFetch('/api/ticket/issue', {
                    method: 'POST',
                    body: JSON.stringify({ recipientEmail })
                });

                const data = await response.json();

                if (data.success) {
                    const ticketUrl = data.ticketUrl;
                    alert(`âœ… é—¨ç¥¨å‘æ”¾æˆåŠŸï¼\n\næ¥æ”¶è€…ï¼š${recipientEmail}\n\né—¨ç¥¨é“¾æ¥ï¼š\n${ticketUrl}\n\nè¯·å°†æ­¤é“¾æ¥å‘é€ç»™å¯¹æ–¹ã€‚`);

                    // å¯é€‰ï¼šå¤åˆ¶åˆ°å‰ªè´´æ¿
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(ticketUrl);
                        console.log('é—¨ç¥¨é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }
                } else {
                    alert('å‘æ”¾å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('å‘æ”¾é—¨ç¥¨å¤±è´¥:', error);
                alert('å‘æ”¾é—¨ç¥¨å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ========================================
        // ç®¡ç†å‘˜åŠŸèƒ½
        // ========================================

        // åŠ è½½å€™é€‰è€…åˆ—è¡¨
        async function loadCandidates() {
            try {
                const response = await authFetch('/api/admin/candidates');
                const data = await response.json();

                if (data.success) {
                    renderCandidates(data.candidates);
                } else {
                    document.getElementById('candidatesList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">âŒ</div>
                            <div>åŠ è½½å¤±è´¥ï¼š${data.message}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½å€™é€‰è€…å¤±è´¥:', error);
                document.getElementById('candidatesList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <div>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“å€™é€‰è€…åˆ—è¡¨
        function renderCandidates(candidates) {
            const listEl = document.getElementById('candidatesList');

            if (!candidates || candidates.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âœ…</div>
                        <div>æš‚æ— å¾…å®¡æ ¸å€™é€‰è€…</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = candidates.map(candidate => {
                const joinedDate = new Date(candidate.createdAt).toLocaleDateString();
                return `
                    <div class="candidate-item">
                        <div class="candidate-info">
                            <div class="candidate-name">${candidate.username}</div>
                            <div class="candidate-meta">
                                ğŸ“§ ${candidate.email} | ğŸ“… ${joinedDate}
                            </div>
                        </div>
                        <div class="candidate-actions">
                            <button class="btn-approve" onclick="approveCandidate('${candidate.id}', '${candidate.username}')">
                                âœ… æ‰¹å‡†
                            </button>
                            <button class="btn-reject" onclick="rejectCandidate('${candidate.id}', '${candidate.username}')">
                                âŒ æ‹’ç»
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ‰¹å‡†å€™é€‰è€…
        async function approveCandidate(candidateId, candidateName) {
            if (!confirm(`ç¡®è®¤æ‰¹å‡† ${candidateName} åŠ å…¥è¶…åä½“ï¼Ÿ`)) return;

            try {
                const response = await authFetch('/api/admin/approve-candidate', {
                    method: 'POST',
                    body: JSON.stringify({ candidateId })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… å·²æ‰¹å‡† ${candidateName}ï¼\n\nè¶…åä½“åºå·ï¼š#${data.member.serialNumber}`);
                    await loadCandidates(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('æ‰¹å‡†å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æ‰¹å‡†å€™é€‰è€…å¤±è´¥:', error);
                alert('æ‰¹å‡†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ‹’ç»å€™é€‰è€…
        async function rejectCandidate(candidateId, candidateName) {
            const reason = prompt(`ç¡®è®¤æ‹’ç» ${candidateName}ï¼Ÿ\n\nè¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼ˆå¯é€‰ï¼‰ï¼š`);
            if (reason === null) return; // ç”¨æˆ·å–æ¶ˆ

            try {
                const response = await authFetch('/api/admin/reject-candidate', {
                    method: 'POST',
                    body: JSON.stringify({ candidateId, reason })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âŒ å·²æ‹’ç» ${candidateName}`);
                    await loadCandidates(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('æ‹’ç»å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æ‹’ç»å€™é€‰è€…å¤±è´¥:', error);
                alert('æ‹’ç»å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
    </script>
</body>
</html>
