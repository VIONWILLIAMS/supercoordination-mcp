# 超协体权限控制与数据安全方案

## 🚨 当前风险评估

### 风险等级：⚠️ **中等**

**现状**：
- ❌ 无身份验证（任何人都可连接）
- ❌ 无权限控制（所有人权限相同）
- ❌ 无操作审计（不知道谁做了什么）
- ✅ 无删除功能（降低了风险）
- ✅ 数据持久化（可恢复）

**潜在威胁**：
1. **恶意篡改**：修改他人任务状态
2. **数据污染**：创建大量垃圾数据
3. **信息泄露**：所有数据对所有人可见
4. **拒绝服务**：恶意请求导致服务崩溃

---

## 🛡️ 三阶段防护方案

### 阶段一：临时保护（立即实施）

**[🏔️土 | 术]** - 数据备份与恢复

#### 1.1 自动备份系统

```bash
# 每5分钟自动备份一次
*/5 * * * * /Users/personalworkplacce/ClaudeWorkspace/supercoordination-mcp/backup-data.sh
```

**保护能力**：
- ✅ 数据可恢复（最多丢失5分钟）
- ✅ 审计追踪（通过备份对比）
- ⚠️ 不能阻止攻击

#### 1.2 访问控制（网络层）

```bash
# 方案A：仅本地访问（最安全）
# 修改 server.js: app.listen(PORT, '127.0.0.1')

# 方案B：局域网白名单（中等安全）
# 使用 iptables 或防火墙限制IP

# 方案C：VPN隧道（推荐）
# 通过 Tailscale/WireGuard 建立私有网络
```

**保护能力**：
- ✅ 阻止外部攻击
- ⚠️ 内部人员仍无权限区分

#### 1.3 操作日志

**实现**：在每个工具调用时记录：
```javascript
{
  timestamp: "2026-01-31T00:35:00Z",
  tool: "update_task_status",
  user: "opencode-user-1",  // 从连接信息提取
  params: {...},
  ip: "192.168.1.100"
}
```

**保护能力**：
- ✅ 事后审计（知道谁做了什么）
- ⚠️ 不能事前阻止

---

### 阶段二：权限系统（中期方案，2-4周实施）

**[⚙️金 | 法]** - 法则与结构

#### 2.1 四级权限模型

| 角色 | 权限 | 典型用户 |
|------|------|---------|
| **Owner** | 完全控制 | 指挥官 |
| **Admin** | 管理成员、分配任务 | 核心团队 |
| **Member** | 创建/更新自己的任务 | 协作成员 |
| **Viewer** | 只读查看 | 观察者、审计 |

#### 2.2 权限规则表

| 工具 | Owner | Admin | Member | Viewer |
|------|-------|-------|--------|--------|
| register_member | ✅ | ✅ | ❌ | ❌ |
| create_task | ✅ | ✅ | ✅ | ❌ |
| assign_task | ✅ | ✅ | ❌ | ❌ |
| update_task_status | ✅ | ✅ | 自己的✅ | ❌ |
| get_my_tasks | ✅ | ✅ | ✅ | ✅ |
| list_all_members | ✅ | ✅ | ✅ | ✅ |

#### 2.3 身份验证方案

**选项A：API Key（简单）**
```javascript
// 请求头
{
  "Authorization": "Bearer sk-super-abc123xyz"
}

// 服务器验证
if (apiKey === config.users[userId].apiKey) {
  // 允许操作
}
```

**选项B：OAuth 2.0（标准）**
- 支持 GitHub/Google 登录
- 标准化协议
- 可撤销令牌

**选项C：签名验证（去中心化）**
```javascript
// 每个用户有公私钥对
// 请求必须用私钥签名
const signature = sign(request, privateKey);
// 服务器用公钥验证
verify(request, signature, publicKey);
```

**推荐**：阶段二使用 **API Key**（快速实现）

#### 2.4 数据所有权

**规则**：
- 每个成员/任务记录 `created_by` 字段
- 只有创建者和 Admin 可以修改
- 删除需要 Owner 权限

```javascript
{
  id: "task-123",
  title: "开发API",
  created_by: "user-alice",
  assigned_to: "user-bob",
  metadata: {
    created_at: "2026-01-31T00:00:00Z",
    updated_by: ["user-alice", "admin-claude"],
    edit_history: [...]
  }
}
```

---

### 阶段三：区块链式架构（长期方案，3-6个月）

**[⚙️金 | 道]** - 终极安全

#### 3.1 不可篡改日志

**设计**：每次操作生成一个哈希链接的区块

```javascript
{
  block_id: 1001,
  previous_hash: "0x7a8f...",
  timestamp: "2026-01-31T00:00:00Z",
  operation: {
    type: "update_task_status",
    user: "alice",
    task_id: "task-123",
    from: "pending",
    to: "in_progress"
  },
  current_hash: "0x9c2e..."  // hash(previous_hash + operation)
}
```

**特性**：
- ✅ 完整审计追踪
- ✅ 防篡改（修改历史会破坏哈希链）
- ✅ 分布式验证

#### 3.2 共识机制

**问题**：多个节点同时修改数据怎么办？

**解决方案**：
- **单主节点模式**（简单）：一个节点负责写入
- **CRDT 算法**（推荐）：冲突自动合并
- **RAFT 共识**（复杂）：多数节点同意才写入

#### 3.3 智能合约式规则

**示例**：任务只能按流程变化
```javascript
// 状态机规则
const allowedTransitions = {
  pending: ["in_progress", "cancelled"],
  in_progress: ["completed", "blocked"],
  blocked: ["in_progress"],
  completed: [] // 终态，不可改变
};

// 自动验证
if (!allowedTransitions[currentStatus].includes(newStatus)) {
  throw new Error("非法状态转换");
}
```

---

## 📋 实施优先级

### 立即实施（本周）

1. ✅ **部署自动备份脚本**
   ```bash
   # 添加到 crontab
   */5 * * * * ~/ClaudeWorkspace/supercoordination-mcp/backup-data.sh
   ```

2. ✅ **限制网络访问**
   - 改为仅 localhost（如果只有你用）
   - 或使用 Tailscale VPN

3. ✅ **添加操作日志**
   - 修改 server.js，记录所有操作

### 近期实施（2-4周）

4. 🔨 **实现 API Key 验证**
5. 🔨 **添加角色权限系统**
6. 🔨 **实现 created_by 所有权**

### 远期规划（3-6个月）

7. 🎯 **区块链式审计日志**
8. 🎯 **分布式共识机制**
9. 🎯 **智能合约规则引擎**

---

## 🤝 临时协作协议（人工规范）

**在技术方案完成前，采用社区规范**：

### 协作公约

1. **不修改他人创建的数据**
   - 除非得到明确授权
   - 使用备注说明修改原因

2. **标记数据所有权**
   - 成员命名：`工具名_用户名`（如：`OpenCode_Alice`）
   - 任务标题包含创建者（如：`[Claude创建] 开发API`）

3. **定期备份**
   - 每天手动备份一次 `store.json`

4. **冲突解决**
   - 通过外部沟通协商
   - 查看备份对比历史

### 信任模型

**适用场景**：
- ✅ 小团队（2-5人）
- ✅ 互相信任的成员
- ✅ 测试/学习阶段

**不适用**：
- ❌ 开放社区
- ❌ 商业生产环境
- ❌ 敏感数据

---

## 🎯 推荐方案（指挥官当前阶段）

**基于你的使用场景（个人+小团队测试）**：

### 立即执行（今天）

```bash
# 1. 启用自动备份
cd ~/ClaudeWorkspace/supercoordination-mcp
./backup-data.sh

# 2. 设置定时任务
crontab -e
# 添加：*/5 * * * * ~/ClaudeWorkspace/supercoordination-mcp/backup-data.sh

# 3. 限制为本地访问（可选）
# 编辑 server.js line 766
# 改为：app.listen(PORT, '127.0.0.1', () => {...})
```

### 2周内实施

- 设计 API Key 方案
- 实现基础权限检查
- 添加操作日志

---

**[🏔️土 | 道]**

**核心原则**：**安全性 > 便利性 > 功能性**

数据是超协体的生命，保护好筹码数据库就是保护主权！
